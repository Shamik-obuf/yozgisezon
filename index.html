<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Erkaklar Oyoq Kiyimlari</title>
  <style>
    :root{
      --bg:#f4f4f4;--card:#fff;--ink:#222;--muted:#666;--green:#2e7d32;--green-dark:#1b5e20;--red:#d32f2f;--accent:#e0e0e0
    }
    *{box-sizing:border-box}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Times New Roman", sans-serif;margin:0;padding:0;background:var(--bg);color:var(--ink)}
    header{background:#222;color:#fff;padding:16px;text-align:center}
    header p{margin:6px 0 0;font-size:14px;opacity:.9}

    #toolbar{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;padding:12px}
    #search{padding:10px;border:1px solid #ccc;border-radius:8px;min-width:260px}

    #products{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;padding:20px}
    @media (max-width:1200px){#products{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:900px){#products{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:680px){#products{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:480px){#products{grid-template-columns:1fr}}

    .product{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);text-align:center;position:relative}
    .product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;cursor:pointer;background:#fafafa}
    .title{margin:8px 0 4px;font-size:16px}
    .price{color:var(--red);font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .stock{display:inline-block;margin-top:6px;padding:4px 8px;border-radius:999px;background:#f5f5f5;border:1px solid #eee;font-size:12px}
    .btn{background:var(--green);color:#fff;padding:9px 12px;border:none;border-radius:8px;margin-top:6px;font-size:14px;cursor:pointer}
    .btn:hover{background:var(--green-dark)}
    .btn.light{background:#eee;color:#111}
    .btn.light:hover{background:#ddd}
    .btn.danger{background:#c62828}
    .btn.danger:hover{background:#8e0000}
    .row{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}

    #pagination{padding:10px;text-align:center}
    .page-btn{padding:6px 12px;margin:5px;border:1px solid #ccc;background:#eee;border-radius:8px;cursor:pointer}
    .page-btn.active{background:#bbb;font-weight:bold}

    section.card{padding:20px;background:#fff;margin:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06)}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:999;place-items:center}
    .modal-content{max-width:min(900px,92vw);max-height:80vh;border-radius:10px;display:block}
    .close{position:absolute;top:14px;right:20px;color:white;font-size:36px;cursor:pointer}

    /* Admin */
    #admin-panel h3{margin-top:0}
    .admin-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}
    .kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f2f2f2;border:1px solid #e5e5e5;border-radius:6px;padding:2px 6px;color:#444}
  </style>
</head>
<body>
  <header>
    <h1>Erkaklar Oyoq Kiyimlari</h1>
    <p>Murojaat uchun: +998 91 245 55 75</p>
  </header>

  <div id="toolbar">
    <input id="search" placeholder="Qidirish: nomi, razmeri..." oninput="applyFilters()" />
    <button id="admin-btn" class="btn" onclick="toggleAdmin()">Admin panelga kirish</button>
  </div>

  <div id="products"></div>
  <div id="pagination"></div>

  <section id="cart" class="card">
    <h2>Korzinka</h2>
    <ul id="cart-items"></ul>
  </section>

  <section id="order-form" class="card">
    <h2>Buyurtma berish</h2>
    <form onsubmit="submitOrder(event)">
      <input type="text" id="name" placeholder="Ismingiz" required />
      <br /><br />
      <input type="text" id="phone" placeholder="Telefon raqamingiz" required />
      <br /><br />
      <button type="submit" class="btn">üì¶ Buyurtma berish</button>
    </form>
      <div class="row" style="margin-top:8px"><button class="btn danger" type="button" onclick="logoutAdmin()">Chiqish</button></div>
  </section>

  <section id="admin-panel" class="card" style="display:none">
    <h3>Mahsulot qo‚Äòshish / tahrirlash</h3>
    <form id="product-form" onsubmit="upsertProduct(event)">
      <input id="p-id" type="hidden" />
      <div class="row">
        <input id="p-name" placeholder="Nomi" required />
        <input id="p-price" type="number" placeholder="Narxi (so'm)" min="0" required />
        <input id="p-size" placeholder="Razmer (masalan: 40,41,42 yoki S/M/L)" required />
        <input id="p-stock" type="number" placeholder="Qoldiq (pachka)" min="0" required />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="p-img" placeholder="Rasm nomi (ixtiyoriy)" />
        <input id="p-file" type="file" accept="image/*" />
        <button class="btn" type="submit" id="submit-btn">‚ûï Qo‚Äòshish</button>
        <button class="btn light" type="button" onclick="resetForm()">üîÑ Tozalash</button>
      </div>
      <p class="muted">Rasm uchun: kompyuter/telefoningizdan fayl tanlashingiz yoki rasm nomini yozishingiz mumkin. Fayl tanlansa, saqlanganda brauzer xotirasida (LocalStorage) rasm sifatida saqlanadi.</p>
    </form>
  </section>

  <!-- Admin login modal (parol ko'rinmaydi, ixtiyoriy ko'rsatish mumkin) -->
  <div id="adminLogin" class="modal" onclick="if(event.target.id==='adminLogin') closeAdminLogin()">
    <div style="background:#fff;padding:20px;border-radius:12px;max-width:360px;width:92vw">
      <h3 style="margin-top:0">Admin kirish</h3>
      <input type="password" id="admin-pass" placeholder="Parol" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px" />
      <label class="muted" style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input type="checkbox" id="show-pass" onchange="togglePass()" /> Parolni ko‚Äòrsatish
      </label>
      <div class="row" style="margin-top:12px">
        <button class="btn" onclick="handleAdminLogin()">Kirish</button>
        <button class="btn light" type="button" onclick="closeAdminLogin()">Bekor qilish</button>
      </div>
      <div id="login-error" class="muted" style="color:#c62828;margin-top:8px;display:none">Parol noto‚Äòg‚Äòri</div>
    </div>
  </div>

  <div id="imgModal" class="modal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage" />
  </div>

  <script>
    // === Ma'lumotlar bazasi (LocalStorage) ===
    const LS_KEY = "mahsulotlar";
    let mahsulotlar = loadProducts();

    function loadProducts(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw){
          const arr = JSON.parse(raw);
          return arr.map(m=>({
            id:m.id, nom:m.nom, narx:+m.narx, razmer:m.razmer, rasm:m.rasm, qoldiq: Number.isFinite(+m.qoldiq)? +m.qoldiq : 10
          }));
        }
      }catch(e){ console.warn("LocalStorage o'qishda xatolik", e); }
      // Dastlabki 20 ta namunaviy mahsulot
      return Array.from({length:20}, (_,i)=>({
        id:i+1,
        nom:`Mahsulot ${i+1}`,
        narx: 50000 + i*5000,
        razmer: ["40","41","42","43"][i%4],
        rasm: `Mahsulot${i+1}.jpg`,
        qoldiq: 20 - (i%7)
      }));
    }
    function saveProducts(){ localStorage.setItem(LS_KEY, JSON.stringify(mahsulotlar)); }

    // === UI holatlari ===
    const cart = [];
    const perPage = 10;
    let currentPage = 1;
    let isAdmin = false; // sessiya
    // Brauzer xotirasidan holatni tiklash
    try{ isAdmin = localStorage.getItem('isAdmin')==='1'; }catch(_e){}
    setTimeout(setAdminUI,0);
    let editingId = null;

    // === Render ===
    function render(){
      const list = getFilteredProducts();
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const visible = list.slice(start, end);

      document.getElementById("products").innerHTML = visible.map(m=>{
        const disabled = m.qoldiq <= 0;
        const qtyOptions = Array.from({length: Math.max(0, Math.min(5, m.qoldiq))}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");
        return `
          <div class="product">
            ${isAdmin ? `
              <div class="admin-actions">
                <button class="btn light" onclick="startEdit(${m.id})" title="Tahrirlash">‚úèÔ∏è</button>
                <button class="btn danger" onclick="removeProduct(${m.id})" title="O‚Äòchirish">üóëÔ∏è</button>
              </div>` : ""}
            <img src="${m.rasm || ''}" alt="${m.nom}" onerror="this.src='';this.style.background='#eee'" onclick="openModal(this)" />
            <h3 class="title">${m.nom}</h3>
            <div class="price">${Number(m.narx).toLocaleString()} so'm</div>
            <div class="muted">Razmer: ${m.razmer}</div>
            <div class="stock">Qoldiq: ${m.qoldiq} pachka</div>
            ${disabled ? `<div class="muted" style="margin-top:6px">Sotilib bo‚Äòlgan</div>` : `
              <div class="row" style="margin-top:8px">
                <select id="qty-${m.id}">${qtyOptions}</select>
                <button class="btn" onclick="addToCart(${m.id})">Korzinkaga qo‚Äòshish</button>
              </div>`}
          </div>`
      }).join("");

      const totalPages = Math.max(1, Math.ceil(list.length / perPage));
      if(currentPage > totalPages){ currentPage = totalPages; }
      document.getElementById("pagination").innerHTML = Array.from({length: totalPages}, (_,i)=>
        `<button class="page-btn ${i+1===currentPage?'active':''}" onclick="goToPage(${i+1})">${i+1}</button>`
      ).join("");
    }

    function getFilteredProducts(){
      const q = document.getElementById('search').value?.toLowerCase() || '';
      if(!q) return mahsulotlar;
      return mahsulotlar.filter(m =>
        m.nom.toLowerCase().includes(q) || String(m.razmer).toLowerCase().includes(q)
      );
    }
    function applyFilters(){ currentPage = 1; render(); }

    function goToPage(p){ currentPage = p; render(); }

    // === Korzinka ===
    function addToCart(id){
      const item = mahsulotlar.find(m=>m.id===id);
      if(!item) return;
      if(item.qoldiq <= 0) return alert("Bu mahsulot qolmagan");
      const qty = +document.getElementById(`qty-${id}`).value || 1;
      if(qty > item.qoldiq){
        return alert(`Omborda faqat ${item.qoldiq} pachka bor`);
      }
      const existing = cart.find(c=>c.id===id);
      if(existing){
        if(existing.qty + qty > item.qoldiq){
          return alert(`Jami ${item.qoldiq} pachkadan oshib ketdi`);
        }
        existing.qty += qty;
      }else{
        cart.push({...item, qty});
      }
      updateCart();
    }

    function updateCart(){
      document.getElementById("cart-items").innerHTML = cart.map(i=>
        `<li>${i.nom} ‚Äî ${i.qty} ta ‚Äî ${(i.qty*i.narx).toLocaleString()} so'm</li>`
      ).join("");
    }

    // === Buyurtma (stockni kamaytirish bilan) ===
    async function submitOrder(e){
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      if(cart.length===0) return alert("Korzinkangiz bo‚Äòsh");
      if(!/^\+?\d[\d\s-]{7,}$/.test(phone)) return alert("Telefon raqamini to‚Äòg‚Äòri kiriting");

      let msg = `üõí Buyurtma\nüë§ ${name}\nüìû ${phone}\n`;
      cart.forEach(i=> msg += `- ${i.nom} ‚Äî ${i.qty} ta\n`);

      // Eslatma: tokenni ochiq kodda saqlash tavsiya etilmaydi. Server orqalik yuborish xavfsizroq.
      try{
        const r = await fetch("https://api.telegram.org/bot7574033100:AAGNZ0TLWWUS75faGkN0TZPg58aJ5UQqY4I/sendMessage",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({chat_id: 1314698716, text: msg})
        });
        if(r.ok){
          alert("‚úÖ Buyurtma yuborildi!");
          // Ombordagi qoldiqni kamaytirish
          cart.forEach(c=>{
            const idx = mahsulotlar.findIndex(m=>m.id===c.id);
            if(idx>-1){
              mahsulotlar[idx].qoldiq = Math.max(0, (mahsulotlar[idx].qoldiq || 0) - c.qty);
            }
          });
          saveProducts();
          cart.length = 0; updateCart(); render();
        }else{
          alert("‚ùå Xatolik: " + r.status);
        }
      }catch(err){
        alert("‚ùå Tarmoq xatoligi: "+ err.message);
      }
    }

    // === Modal (rasm) ===
    function openModal(img){
      document.getElementById("imgModal").style.display = "grid";
      document.getElementById("modalImage").src = img.src;
    }
    function closeModal(){ document.getElementById("imgModal").style.display = "none"; }

    // === Admin sessiyasi va login ===
    function openAdminLogin(){ document.getElementById('adminLogin').style.display = 'grid'; setTimeout(()=>document.getElementById('admin-pass').focus(), 50); }
    function closeAdminLogin(){ document.getElementById('adminLogin').style.display = 'none'; document.getElementById('login-error').style.display='none'; }
    function togglePass(){ const p = document.getElementById('admin-pass'); p.type = (p.type==='password'?'text':'password'); }
    function handleAdminLogin(){
      const pass = (document.getElementById('admin-pass').value || '').trim();
      if(pass === 'admin123'){
        isAdmin = true; localStorage.setItem('isAdmin','1');
        document.getElementById('admin-panel').style.display = 'block';
        setAdminUI(); closeAdminLogin(); render();
      }else{
        document.getElementById('login-error').style.display='block';
      }
    }
    function logoutAdmin(){ isAdmin=false; localStorage.removeItem('isAdmin'); document.getElementById('admin-panel').style.display='none'; setAdminUI(); render(); }
    function setAdminUI(){
      const btn = document.getElementById('admin-btn');
      if(!btn) return;
      btn.textContent = isAdmin ? 'Admin rejimdan chiqish' : 'Admin panelga kirish';
    }

    // Yangi mahsulot qo'shish yoki tahrirlash
    async function upsertProduct(e){
      e.preventDefault();
      const idInput = document.getElementById('p-id');
      const nom = document.getElementById('p-name').value.trim();
      const narx = +document.getElementById('p-price').value;
      const razmer = document.getElementById('p-size').value.trim();
      const qoldiq = +document.getElementById('p-stock').value;
      const rasmText = document.getElementById('p-img').value.trim();
      const fileInput = document.getElementById('p-file');

      if(!nom || !Number.isFinite(narx) || !razmer){
        return alert("Ma'lumotlarni to‚Äòliq to‚Äòldiring");
      }

      let rasm = rasmText; // default ‚Äî yozilgan nom
      const file = fileInput.files && fileInput.files[0];
      if(file){ // Fayl tanlangan bo‚Äòlsa, dataURL ko‚Äòrinishida saqlaymiz
        rasm = await fileToDataURL(file);
      }

      if(idInput.value){
        // Update
        const id = +idInput.value;
        const idx = mahsulotlar.findIndex(m=>m.id===id);
        if(idx>-1){
          const old = mahsulotlar[idx];
          mahsulotlar[idx] = { id, nom, narx, razmer, qoldiq, rasm: rasm || old.rasm };
        }
        alert("‚úèÔ∏è Mahsulot yangilandi");
      }else{
        // Insert (yangi)
        const yangi = { id: Date.now(), nom, narx, razmer, qoldiq, rasm };
        mahsulotlar.unshift(yangi);
        alert("‚úÖ Mahsulot qo‚Äòshildi");
      }
      saveProducts();
      render();
      resetForm();
    }

    function startEdit(id){
      const m = mahsulotlar.find(x=>x.id===id);
      if(!m) return;
      editingId = id;
      document.getElementById('p-id').value = m.id;
      document.getElementById('p-name').value = m.nom;
      document.getElementById('p-price').value = m.narx;
      document.getElementById('p-size').value = m.razmer;
      document.getElementById('p-stock').value = m.qoldiq;
      document.getElementById('p-img').value = (m.rasm && !m.rasm.startsWith('data:')) ? m.rasm : '';
      document.getElementById('p-file').value = '';
      document.getElementById('submit-btn').textContent = 'üíæ Saqlash';
      window.scrollTo({top: document.getElementById('admin-panel').offsetTop - 10, behavior:'smooth'});
    }

    function removeProduct(id){
      if(!confirm('Ushbu mahsulotni o‚Äòchirishni tasdiqlaysizmi?')) return;
      mahsulotlar = mahsulotlar.filter(m=>m.id!==id);
      saveProducts();
      render();
    }

    function resetForm(){
      editingId = null;
      document.getElementById('product-form').reset();
      document.getElementById('p-id').value = '';
      document.getElementById('submit-btn').textContent = '‚ûï Qo‚Äòshish';
    }

    function fileToDataURL(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Boshlang‚Äòich chizish
    render();
  </script>
</body>
</html>
